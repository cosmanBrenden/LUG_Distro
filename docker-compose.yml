version: '3.8'

services:
  # Main ISO builder service
  iso-builder:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: "${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
        VERSION: "${VERSION:-1.0.0}"
    image: lug-distro-builder:latest
    container_name: lug-iso-builder
    privileged: true
    volumes:
      - ./build:/build/output
      - ./scripts:/scripts
      - ./config:/build/config
      - iso-cache:/var/cache/apt
      - debootstrap-cache:/var/cache/debootstrap
    environment:
      - DISTRO_NAME=LUG
      - DISTRO_VERSION=${VERSION:-1.0.0}
      - ISO_NAME=lug-live-${VERSION:-1.0.0}-amd64.iso
      - DEBIAN_RELEASE=bookworm
    working_dir: /build
    command: /scripts/build-iso.sh

  # Development environment with shell access
  dev-env:
    build:
      context: .
      dockerfile: Dockerfile
    image: lug-distro-builder:latest
    container_name: lug-dev-env
    privileged: true
    volumes:
      - ./build:/build/output
      - ./scripts:/scripts
      - ./config:/build/config
      - iso-cache:/var/cache/apt
      - debootstrap-cache:/var/cache/debootstrap
    environment:
      - DISTRO_NAME=LUG
      - DISTRO_VERSION=${VERSION:-1.0.0}
      - DEBIAN_RELEASE=bookworm
    working_dir: /build
    stdin_open: true
    tty: true
    command: /bin/bash

  # ISO testing environment (for future QEMU testing)
  iso-test:
    image: tianon/qemu
    container_name: lug-iso-test
    privileged: true
    volumes:
      - ./build:/build:ro
    command: >
      qemu-system-x86_64
      -m 4096
      -smp 2
      -enable-kvm
      -cdrom /build/lug-live.iso
      -boot d
      -vga virtio
      -display gtk
    profiles:
      - testing

volumes:
  iso-cache:
    driver: local
  debootstrap-cache:
    driver: local
